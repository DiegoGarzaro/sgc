{% extends 'base.html' %}

{% block title %}
SGC - Montagens
{% endblock %}

{% block content %}

<div class="mb-4"></div>

{% if perms.assemblies.add_assembly %}
<div class="row mb-3">
  <div class="col-md-12 text-end pe-4">
    <a href="{% url 'assembly_create' %}" class="btn btn-success">
      <i class="bi bi-plus"></i> Adicionar Montagem
    </a>
  </div>
</div>
{% endif %}

<div class="card mb-3">
  <div class="card-header">
    <strong>Filtros</strong>
  </div>
  <div class="card-body">
    <form id="filter-form" method="get" action="{% url 'assembly_list' %}">
      <input type="hidden" name="sort" id="sort-field" value="{{ request.GET.sort|default:'' }}">
      <input type="hidden" name="order" id="sort-order" value="{{ request.GET.order|default:'' }}">
      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="name" class="form-label">Nome da Montagem</label>
          <input type="text" class="form-control" name="name" id="name" placeholder="Buscar por nome"
            value="{{ request.GET.name }}">
        </div>
      </div>
    </form>
  </div>
</div>

<div class="table-responsive">
  <table class="table table-striped table-bordered">
    <thead class="thead-dark">
      <tr>
        <th>
          <div class="d-flex align-items-center cursor-pointer sort-header" data-sort="name">
            Nome
            <div class="ms-2 d-flex flex-column sort-arrows">
              <i class="bi bi-caret-up-fill {% if request.GET.sort == 'name' and request.GET.order == 'asc' %}text-primary{% else %}text-muted{% endif %}"
                style="font-size: 0.7rem; margin-bottom: -3px;"></i>
              <i class="bi bi-caret-down-fill {% if request.GET.sort == 'name' and request.GET.order == 'desc' %}text-primary{% else %}text-muted{% endif %}"
                style="font-size: 0.7rem;"></i>
            </div>
          </div>
        </th>
        <th>Descrição</th>
        <th class="text-center">Ações</th>
      </tr>
    </thead>
    <tbody id="assemblyTableBody">
      {% for assembly in assemblies %}
      <tr>
        <td>
          <a href="{% url 'assembly_detail' assembly.id %}" class="text-info">
            {{ assembly.name }}
          </a>
        </td>
        <td>
        {% if assembly.description %}
            {{ assembly.description }}
        {% else %}
            <span class="text-muted">Nenhuma descrição</span>
        {% endif %}
        </td>
        <td class="text-center">
          <div role="group">
            {% if perms.assemblies.view_assembly %}
            <a href="{% url 'assembly_detail' assembly.id %}" class="btn btn-info btn-sm">
              <i class="bi bi-eye"></i>
            </a>
            {% endif %}
            {% if perms.assemblies.change_assembly %}
            <a href="{% url 'assembly_update' assembly.id %}" class="btn btn-warning btn-sm">
              <i class="bi bi-pencil"></i>
            </a>
            {% endif %}
            {% if perms.assemblies.delete_assembly %}
            <a href="{% url 'assembly_delete' assembly.id %}" class="btn btn-danger btn-sm">
              <i class="bi bi-trash"></i>
            </a>
            {% endif %}
          </div>
        </td>
      </tr>
      {% endfor %}
      {% if assemblies|length == 0 %}
      <tr>
        <td colspan="4" class="text-center">Nenhum item encontrado.</td>
      </tr>
      {% endif %}
    </tbody>
  </table>
</div>

{% include 'components/_pagination.html' %}

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const filterForm = document.getElementById('filter-form');
    const assemblyTableBody = document.getElementById('assemblyTableBody');

    // Restore scroll position after page load if available
    const savedScrollPos = localStorage.getItem('scrollPos');
    if (savedScrollPos) {
      window.scrollTo(0, parseInt(savedScrollPos, 10));
      localStorage.removeItem('scrollPos');
    }

    // Debounce function for filtering
    function debounce(func, delay) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), delay);
      };
    }

    // AJAX filter application
    function applyFilter() {
      const formData = new FormData(filterForm);
      const query = new URLSearchParams(formData).toString();
      fetch(`${filterForm.action}?${query}`, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
      })
      .then(response => response.text())
      .then(data => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(data, 'text/html');
        const newTableBody = doc.getElementById('assemblyTableBody');
        if (newTableBody) {
          assemblyTableBody.innerHTML = newTableBody.innerHTML;
        }
      })
      .catch(error => console.error('Error fetching filtered data:', error));
    }

    function storeScrollAndSubmit() {
      localStorage.setItem('scrollPos', window.scrollY.toString());
      filterForm.submit();
    }

    // Sort headers event
    document.querySelectorAll('.sort-header').forEach(header => {
      header.style.cursor = 'pointer';
      header.addEventListener('click', function() {
        const sortField = this.dataset.sort;
        const currentSort = document.getElementById('sort-field').value;
        const currentOrder = document.getElementById('sort-order').value;

        let newOrder = 'asc';
        if (sortField === currentSort) {
          newOrder = currentOrder === 'asc' ? 'desc' : 'asc';
        }

        document.getElementById('sort-field').value = sortField;
        document.getElementById('sort-order').value = newOrder;

        // Store scroll position before submitting
        storeScrollAndSubmit();
      });
    });

    // Hover styling for sort headers
    document.querySelectorAll('.sort-header').forEach(header => {
      header.addEventListener('mouseenter', function () {
        this.style.backgroundColor = 'rgba(0,0,0,0.05)';
      });

      header.addEventListener('mouseleave', function () {
        this.style.backgroundColor = 'transparent';
      });
    });

    // Trigger AJAX filtering on filter input changes
    filterForm.querySelectorAll('input, select').forEach(element => {
      element.addEventListener('input', debounce(applyFilter, 300));
    });
  });
</script>

<style>
  .sort-header {
    transition: background-color 0.2s ease;
    padding: 0.5rem;
    border-radius: 4px;
  }

  .sort-arrows {
    line-height: 0.5;
  }

  .cursor-pointer {
    cursor: pointer;
  }
</style>

{% endblock %}
